<!-- index.html -->
{% extends "user_layout.html" %}

{% block head %}
  <!-- Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
  
  <!-- jQuery and jQuery UI -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
          integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.14.0/jquery-ui.min.js"
          integrity="sha512-MlEyuwT6VkRXExjj8CdBKNgd+e2H+aYZOCUaCrt9KRk6MlZDOs91V1yK22rwm8aCIsb5Ec1euL8f0g58RKT/Pg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{% endblock head %}

{% block content %}
{{ block.super }}
  <main class="relative flex-grow h-full flex flex-col">
    <div id="map" class="h-full flex-grow"></div>
    <!-- Draggable Search Box -->
    <div id="search-box"
         class="absolute top-16 left-32 bg-white z-[9999] p-5 pt-7 rounded-lg opacity-75 hover:opacity-100 transition-opacity">
      <p class="font-semibold text-lg">Search for parking place</p>
      <input id="parking-search" placeholder="Example: Nayabazar"
             class="outline-none border px-2 py-1 rounded mt-2 w-[250px]" />
      <p class="mt-2">Vehicle type</p>
      <select id="vehicle-type" class="w-full bg-gray-100 px-2 py-1 rounded mt-1">
        <option value="">Any</option>
        <option value="Bike">Bike</option>
        <option value="Car">Car</option>
      </select>
      <button id="search-button" class="bg-blue-500 text-white px-3 py-1 rounded mt-3">Search</button>
    </div>
  </main>

  <script>
    // Initialize the map with default location (Kathmandu)
    var map = L.map('map').setView([27.7172, 85.3240], 13);

    // Add OpenStreetMap tile layer
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    var markers = [];  // To store map markers

    // Function to clear existing markers
    function clearMarkers() {
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
    }

    // Function to place markers on the map
    function addMarkers(parkingSpaces) {
        clearMarkers();

        parkingSpaces.forEach(function(parkingSpace) {
            if (parkingSpace.latitude && parkingSpace.longitude) {
                var marker = L.marker([parkingSpace.latitude, parkingSpace.longitude]).addTo(map);
                marker.bindPopup(`
                    <strong>Parking Space:</strong> ${parkingSpace.name || 'Unnamed'}<br>
                    <strong>Vehicle Type:</strong> ${parkingSpace.vehicle_type}<br>
                    <strong>Distance:</strong> ${parkingSpace.distance} meters
                `);
                markers.push(marker);
            }
        });

        if (markers.length > 0) {
            var group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds());
        }
    }

    // Event listener for search button click
    $('#search-button').on('click', function () {
        var searchTerm = $('#parking-search').val().trim();
        var vehicleType = $('#vehicle-type').val();

        if (!searchTerm) {
            alert('Please enter a location to search.');
            return;
        }

        // Use Nominatim API to get coordinates from the location name
        $.ajax({
            url: `https://nominatim.openstreetmap.org/search`,
            method: "GET",
            data: {
                q: searchTerm,
                format: "json",
                limit: 1
            },
            success: function (geoResponse) {
                console.log("Nominatim API Response:", geoResponse); // Debugging response

                if (geoResponse.length > 0) {
                    var location = geoResponse[0];
                    var userLat = location.lat;
                    var userLng = location.lon;

                    // AJAX request to backend to perform KNN search
                    $.ajax({
                        url: "{% url 'search_nearest_parking' %}",
                        type: "GET",
                        data: {
                            'latitude': userLat,
                            'longitude': userLng,
                            'vehicle_type': vehicleType,
                        },
                        success: function (response) {
                            console.log("KNN Search Response:", response); // Debugging response

                            if (response.status === 'success' && response.data.length > 0) {
                                addMarkers(response.data);  // Add new markers based on KNN search
                            } else {
                                clearMarkers();  // Clear the map if no results
                                alert(response.message || 'No parking spaces found.');
                            }
                        },
                        error: function () {
                            alert("Failed to retrieve parking spaces.");
                        }
                    });
                } else {
                    alert('Location not found. Please try another name.');
                }
            },
            error: function () {
                alert('Failed to retrieve location coordinates.');
            }
        });
    });

    // Make the search box draggable
    $("#search-box").draggable({
        containment: "parent"
    });
  </script>
{% endblock content %}
